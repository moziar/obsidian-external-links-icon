# Testing & Verification — External Links Icon plugin

This document lists manual and smoke tests to validate the recent "safe icon injection" changes (no runtime `<style>` insertion, icons inserted as sibling elements, scoped scanning, and MutationObserver improvements).

## Quick smoke test (local)
1. Run:
   - npm run test:smoke
2. Expect: build completes and `smoke ok` is printed.

## Manual verification checklist
Perform the following checks inside Obsidian with this plugin built and loaded (copy `main.js`, `manifest.json`, `styles.css` to your plugin folder and enable plugin):

### 1) Basic injection behavior
- Open a note containing various external links (example: `https://github.com`, `https://baidu.com`, `obsidian://open`, `zotero://...`).
- Ensure appropriate icons appear **immediately after** the links (not inside link text) as inline decorative elements.
- Verify icons are inserted as siblings (not altering link innerHTML) and have the class `.external-links-icon-inline`.
- Confirm that clicking the link still opens the URL as expected (icon should not intercept clicks).

### 2) Accessibility
- Inspect an injected icon DOM node and verify:
  - `aria-hidden="true"`
  - `role="presentation"`
  - `tabindex="-1"` (not focusable)
- Confirm keyboard navigation flows to the link (icons are skipped).

### 3) Theme & preview handling
- Toggle Obsidian theme (dark/light) and confirm appropriate icon appearance for theme-specific icons (if provided).
- Open the note in both *preview* and *source* views; ensure icons appear in preview and do not break source editing behavior.

### 4) Settings & custom icons
- In plugin settings, add a custom Web or Scheme icon, upload a valid SVG, save, and confirm:
  - The new icon appears for matching links.
  - Invalid SVGs show a Notice with appropriate message and are rejected.
  - The Settings preview renders the uploaded SVG correctly.

### 5) No runtime `<style>` elements & perf
- Inspect document for a runtime `<style>` with id `external-links-icon-styles` — plugin should not create any such <style> node at runtime.
- Create a long note with many links and switch between notes; confirm UI remains responsive and the plugin does not saturate CPU (scan operations are debounced).

### 6) Leaf / layout changes
- Open multiple panes (leaves), switch active leaf and layout; verify icons appear when a leaf becomes active and are removed when plugin unloads.

### 7) Edge cases
- Links inside elements with unusual structure (e.g., inside buttons, masked elements) — ensure no exceptions occur.
- If insertion fails, the plugin should gracefully fall back (no thrown errors in console).

## Acceptance criteria
- Icons are inserted as decorative sibling elements, not via runtime CSS injection.
- No alerts are used for user messages — only `Notice()` or modal confirmations.
- Observations are scoped to note content containers and active-leaf changes to minimize noise.
- Build (`npm run build`) succeeds and smoke test passes.


## Optional automated tests
- Consider adding unit tests (e.g., for `sanitizeSvg`, `prepareSvgForSettings`) after factoring helpers into an exported module.


---
Generated by Copilot during PR prep — follow the checklist and paste results into the PR description to expedite review.
